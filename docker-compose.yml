services:
  postgres:
    image: postgres:16
    restart: unless-stopped
    environment:
      POSTGRES_USER: spur
      POSTGRES_PASSWORD: spur
      POSTGRES_DB: spur_chat
    ports:
      - "5432:5432"
    volumes:
      - pgdata:/var/lib/postgresql/data
  redis:
    image: redis:7
    restart: unless-stopped
    ports:
      - "6379:6379"
    volumes:
      - redisdata:/data

  backend:
    build:
      context: ./backend
    restart: unless-stopped
    depends_on:
      - postgres
      - redis
    env_file:
      - ./backend/.env
    environment:
      PORT: "8080"
      NODE_ENV: development
      DATABASE_URL: postgresql://spur:spur@postgres:5432/spur_chat?schema=public
      REDIS_URL: redis://redis:6379
      GEMINI_MODEL: gemini-2.5-flash
      RATE_LIMIT_VISITOR_PER_MINUTE: "10"
      RATE_LIMIT_IP_PER_MINUTE: "60"
      CACHE_TTL_SECONDS: "900"
      MAX_ACTIVE_CONVERSATIONS: "3"
      ACTIVE_CONVERSATION_TTL_MINUTES: "1440"
    ports:
      - "8080:8080"
    volumes:
      - ./backend:/app
      - backend_node_modules:/app/node_modules

  worker:
    image: spur-assignment-backend
    restart: unless-stopped
    depends_on:
      - postgres
      - redis
    env_file:
      - ./backend/.env
    environment:
      NODE_ENV: development
      DATABASE_URL: postgresql://spur:spur@postgres:5432/spur_chat?schema=public
      REDIS_URL: redis://redis:6379
      GEMINI_MODEL: gemini-2.5-flash
    command: ["npm", "run", "worker:dev"]
    volumes:
      - ./backend:/app
      - backend_node_modules:/app/node_modules

volumes:
  pgdata:
  redisdata:
  backend_node_modules:
